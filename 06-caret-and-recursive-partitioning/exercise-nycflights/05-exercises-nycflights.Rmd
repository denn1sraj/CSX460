---
title: "Caret / Recursive Partitioning"
author: "Dennis Raj"
date: "May 16, 2017"
output: pdf_document
---

```{r init, warning=FALSE, echo=FALSE, message=FALSE}
library(rpart)
library(caret)
library(readr)
library(dplyr)
library(pROC)
library(partykit)
```


## Exercise 1: caret/logistic regression (5 points)

Rebuild your logistic regression model from the previous week, this time using the `caret` package. 

- Calculate the training or apparent performance of the model. 
- Calculate an unbiased measure of performance 
- Create a ROC Curve for your model

Show all work.

```{r logistic model}
flights <- tbl_df(read_csv("flights_clean.csv", col_names = TRUE))
flights$month.x <- as.factor(flights$month.x)
flights$carrier <- as.factor(flights$carrier)
flights$origin <- as.factor(flights$origin)
flights$dest <- as.factor(flights$dest)
flights$late <- as.factor(flights$late)


flights_clean <- flights %>% select(late, month.x, dep_delay, carrier, origin, dest, distance, humid, wind_speed, temp)
glimpse(flights_clean)

set.seed(1234)
inTraining <- createDataPartition(flights_clean$late, p = .75, list = FALSE)
train <- flights_clean[inTraining,]
test <- flights_clean[-inTraining,]
tc <- trainControl(method = "cv", 10, savePredictions=T)
fit1 <- train(late ~ month.x + dep_delay + carrier + origin + dest, data = train, 
                        method = "glm",
                        family = binomial,
                        trControl = tc)

summary(fit1)
head(fit1$pred)
tail(fit1$pred)
fitpred <- ifelse(fit1$finalModel$fitted.values > 0.5, TRUE, FALSE)
fitpred <- as.factor(fitpred)

fit1_cm <- confusionMatrix(data=fitpred, reference = train$late)
fit1_cm

fit1_auc <- roc(train$late, fit1$finalModel$fitted.values)
fit1_auc
plot(fit1_auc)

```


## Exercise 2: caret/rpart (5 points)

Using the `caret` and `rpart` packages, create a **classification** model for flight delays using your NYC FLight data. Your solution should include:

- The use of `caret` and `rpart` to train a model.
- An articulation of the the problem your are 
- An naive model
- An unbiased calculation of the performance metric
- A plot of your model -- (the actual tree; there are several ways to do this)
- A discussion of your model 



Show and describe all work

```{r rpart model}

rpart1 <- rpart(late ~ ., data = flights_clean, method = "class",
                control = rpart.control(minsplit=1, minbucket = 1, cp=0.001))

               
                


rpart1a <- as.party(rpart1)

plot(rpart1a)

```


### Questions:

- Discuss the difference between the models and why you would use one model over the other?
- How might you produce an ROC type curve for the *rpart* model? 
